# Заметки к архитектуре 

## Общая информация
Приложение делится на 4 основных блока:
- `core` - ядро приложения, содержит `step'ы` и `workflow'ы`
- `infrastructure` - инфраструктура приложения, например: клиент базы данных, внешние API и т.д.
- `gateway` - то, через что приложение общается с внешним миром, например: `telegram-bot`, `rest`, `websocket` и т.д.
- `lib` - общий "библиотечный" слой доступный всем в приложении, например: `cron`, `event-emitter` и т.д.

Поток зависимостей:
- `lib` **МОЖЕТ** использовать код только внутри себя
- `infrastructure` **МОЖЕТ** импортировать `lib`
- `core` **МОЖЕТ** импортировать `infrastructure` и `lib`
- `gateway` **МОЖЕТ** импортировать `core` и `lib`


## Core
Основная бизнес-логика приложения, имеет следующую структуру:
- `lib` - переиспользуемый код необходимый для выполнения бизнес-операции (например, `lib/mappers/prisma` для маппера или `lib/transaction` для удобного управления транзакциями)
- `step` - атомарный бизнес сценарий, например: `create-user-profile`, `retrieve-user`, `activate-product`. ВАЖНО - это именно бизнес-сценарий, а не операция работы с БД, и из-за этого чаще всего невозможно существование общих `update` `step'ов`
- `workflow` - комплексный сценарий который включает в себя набор `step'ов` и, возможно, другие небольшие операция внутри себя
- `listeners` - слушатели событий, могут использовать `workflow` внутри себя
- `jobs` - `cron-задачи`, могут использовать `workflow` внутри себя
- `errors` - кастомные ошибки
- `models` - модели данных, чаще всего представленные в виде типов (`type`), например `export type Partner = Omit<PrismaPartner, "userId">`

Примечание:
- `step'ы` могут использовать только внутри `workflow`, они не должны использоваться самостоятельно, так, например, если нам нужно вернуть список пользователей, то мы создаем `list-users-step.ts`, который получает пользователей и `list-users-workflow.ts`, который просто вызывает `list-users-step.ts`
- В данном слое запрещены кросс-импорты везде кроме `models` и `errors`
- Слать эвенты могут только `step'ы`, если нужно послать какой-то эвент из `workflow`, то необходимо создать для этого отдельный `step`. Так например `workflow` обработки заказа (`process-order-workflow`) хочет сообщить что обработка заказа завершилась ошибкой, то ему необходимо использовать для этого `fail-order-step`, который может выполнять, например, только одно действие: `eventEmitter.emit(...)`


## Gateway
- особых требований не предъявляется, достаточно того что каждый тунель использует свою дирректорию, например: `telegram-bot`, `rest`, `websocket`

Примечание:
- может использовать в своей работе `errors`, `models`, `workflows` из `core`
- иногда может использовать `lib`, например импортируя: `eventEmitter`, `logger`, `cron`. Если требуется получить что-то по `API` из стороннего сервиса и это имеет косвенное отношение к бизнес-логике (например получение внешнего идентификатора товара из `CMS`), то для этого должен использоваться отдельный `workflow`, например: `retrieve-cms-product-workflow`


## Infrastructure
- особых требований не предъявляется, достаточно того что каждый инструмент использует свою дирректорию, например: `prisma`, `encryption`, `storage`
- ничего не знает про `core` и `gateway`

---
credit: [qFlensT](https://github.com/qFlensT)
